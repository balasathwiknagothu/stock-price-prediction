<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stock Analytics</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
*{box-sizing:border-box;font-family:Inter,sans-serif}
body{
  margin:0;
  background:radial-gradient(circle at top,#12343f,#071c23);
  color:#fff;
  overflow-x:hidden;
}
.header{text-align:center;padding:28px}
.logo{font-size:24px;font-weight:700;cursor:pointer}
.nav{margin:16px 0}
.nav button{
  background:rgba(255,255,255,.08);
  border:none;color:#fff;
  padding:10px 18px;margin:4px;
  border-radius:22px;cursor:pointer
}
.search-wrap{max-width:900px;margin:18px auto;position:relative}
.search{
  width:100%;padding:22px 34px;
  border-radius:50px;border:none;font-size:18px
}
.results{
  position:absolute;top:90px;width:100%;
  max-height:320px;overflow-y:auto;
  background:rgba(10,30,38,.96);
  border-radius:20px;display:none;z-index:10
}
.result{padding:14px 24px;cursor:pointer}
.result:hover{background:rgba(255,255,255,.1)}
.section{padding:24px 48px}
.cards-row{display:flex;gap:18px}
.cards-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:20px;
  max-height:70vh;
  overflow-y:auto;
}
.card{
  height:120px;
  padding:18px;
  border-radius:18px;
  background:rgba(255,255,255,.08);
  cursor:pointer;
  transition:.2s;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.cards-row .card{flex:0 0 220px;}
.card:hover{transform:translateY(-4px)}
.up{color:#7CFF7C}
.down{color:#FF7C7C}

.detail{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:flex-start;
  justify-content:center;
  overflow-y:auto;
  padding:40px 0;
}
.detail.show{display:flex}

.detail-box{
  width:90%;
  max-width:1000px;
  padding:26px;
  border-radius:22px;
  background:rgba(15,40,48,.96);
}
.back{cursor:pointer;margin-bottom:10px;opacity:.7}
#tvChart{width:100%;height:420px;margin-top:20px}

.spinner {
  width:40px;height:40px;
  border:4px solid rgba(255,255,255,0.2);
  border-top:4px solid #7CFF7C;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}
@keyframes spin {
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}
</style>
</head>

<body>

<div class="header">
  <div class="logo" onclick="goHome()">üìà Stock Analytics</div>
  <div class="nav">
    <button onclick="openList('gainers')">üî• Gainers</button>
    <button onclick="openList('losers')">üìâ Losers</button>
    <button onclick="openList('movers')">‚ö° Movers</button>
  </div>
  <div class="search-wrap">
    <input class="search" id="search" placeholder="Search stocks or symbols‚Ä¶" autocomplete="off">
    <div class="results" id="results"></div>
  </div>
</div>

<div id="content"></div>

<div class="detail" id="detail">
  <div class="detail-box">
    <div class="back" onclick="closeDetail()">‚Üê Back</div>
    <h2 id="d-title"></h2>
    <div id="d-body"></div>
    <div id="chartLoading" style="display:none;text-align:center;padding:40px;">
      <div class="spinner"></div>
      <div style="margin-top:10px;opacity:.7;">Loading chart...</div>
    </div>
    <div id="tvChart"></div>
  </div>
</div>

<script>

let stocks=[];
let chart=null;

fetch("/stocks").then(r=>r.json()).then(d=>stocks=d);

const search=document.getElementById("search");
const results=document.getElementById("results");
const content=document.getElementById("content");

let debounceTimer;

search.addEventListener("focus", () => renderResults(""));

search.addEventListener("input", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    renderResults(search.value.toLowerCase());
  }, 250);
});

function renderResults(query){
  results.innerHTML="";

  const filtered = stocks.filter(s =>
    !query ||
    s.name.toLowerCase().includes(query) ||
    s.symbol.toLowerCase().includes(query)
  ).slice(0, 50);   // limit results for performance

  if(filtered.length === 0){
    results.innerHTML="<div class='result'>No results found</div>";
  } else {
    filtered.forEach(s=>{
      const div=document.createElement("div");
      div.className="result";
      div.textContent=`${s.name} (${s.symbol})`;
      div.onclick=()=>openStock(s.symbol);
      results.appendChild(div);
    });
  }

  results.style.display="block";
}

document.addEventListener("click",e=>{
  if(!e.target.closest(".search-wrap")) {
    results.style.display="none";
  }
});


function stockCard(s){
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
    <div>
      <b>${s.symbol}</b>
    </div>
    <div class="${s.direction=='UP'?'up':'down'}">
      ${s.direction=='UP'?'‚ñ≤':'‚ñº'} ${s.pct_change}%
    </div>`;
  c.onclick=()=>openStock(s.symbol);
  return c;
}

function loadHome(){
  content.innerHTML="";
  Promise.all([
    fetch("/market/gainers/top").then(r=>r.json()),
    fetch("/market/losers/top").then(r=>r.json()),
    fetch("/market/movers/top").then(r=>r.json())
  ]).then(([g,l,m])=>{
    renderSection("GAINERS",g);
    renderSection("LOSERS",l);
    renderSection("MOVERS",m);
  });
}

function renderSection(title,data){
  const sec=document.createElement("div");
  sec.className="section";
  sec.innerHTML=`<h3>${title}</h3><div class="cards-row"></div>`;
  const row=sec.querySelector(".cards-row");
  if(data.length===0){
    row.innerHTML="<div>No data</div>";
  }else{
    data.forEach(s=>row.appendChild(stockCard(s)));
  }
  content.appendChild(sec);
}

function openStock(symbol){
  results.style.display="none";

  const detail=document.getElementById("detail");
  detail.classList.add("show");
  document.getElementById("d-title").innerText=symbol;

  document.getElementById("d-body").innerHTML=`
    <div style="padding:20px;text-align:center;">
      <div class="spinner"></div>
      <div style="margin-top:10px;opacity:.7;">
        Computing ML prediction...
      </div>
    </div>
  `;

  fetch(`/predict?symbol=${symbol}`)
  .then(r=>r.json())
  .then(d=>{
    renderPrediction(symbol,d);
  });
}


function renderPrediction(symbol,d){

  if(!d || d.status !== "done"){
    document.getElementById("d-body").innerHTML = `
      <div style="padding:30px;opacity:.7;text-align:center;">
        Prediction failed
      </div>
    `;
    return;
  }

  const current = d.current_price;
  const pred = d.predictions["1D"].predicted_price;

  const change = ((pred - current) / current) * 100;
  const isUp = change > 0;

  document.getElementById("d-body").innerHTML = `
    <div style="padding:20px;background:rgba(255,255,255,0.05);border-radius:16px;">
      <div>Current: ‚Çπ${current.toFixed(2)}</div>

      <div style="font-size:22px;color:${isUp?'#7CFF7C':'#FF7C7C'}">
        Predicted (1D): ‚Çπ${pred.toFixed(2)}
      </div>

      <div>${change.toFixed(2)}%</div>
    </div>
  `;

  loadChart(symbol);
}


function loadChart(symbol,data){

  const container = document.getElementById("tvChart");
  container.innerHTML = "";

  document.getElementById("chartLoading").style.display = "block";

  fetch(`/history?symbol=${symbol}`)
  .then(res => res.json())
  .then(data => {

    document.getElementById("chartLoading").style.display = "none";

    if(!data || data.length === 0){
      container.innerHTML = "<div style='padding:30px;opacity:.7;'>No historical data</div>";
      return;
    }

    setTimeout(() => {

      chart = LightweightCharts.createChart(container, {
        width: container.clientWidth || 900,
        height: 420,
        layout: {
          background: { color: "#0f2830" },
          textColor: "#aaa"
        },
        grid: {
          vertLines: { color: "rgba(255,255,255,0.05)" },
          horzLines: { color: "rgba(255,255,255,0.05)" }
        }
      });

      // üî• CORRECT SERIES CREATION FOR YOUR VERSION
      const candleSeries = chart.addSeries(
        LightweightCharts.CandlestickSeries,
        {}
      );

      const formatted = data.map(bar => ({
        time: bar.time,
        open: bar.open,
        high: bar.high,
        low: bar.low,
        close: bar.close
      }));

      candleSeries.setData(formatted);
      
      chart.timeScale().fitContent();

      // üîÆ Future projection line
      


      window.addEventListener("resize", () => {
        chart.applyOptions({
          width: container.clientWidth
        });
      });

    }, 100);

  })
  .catch(() => {
    document.getElementById("chartLoading").style.display = "none";
    container.innerHTML = "<div style='padding:30px;opacity:.7;'>Chart load error</div>";
  });
}


function closeDetail(){
  document.getElementById("detail").classList.remove("show");
  if(chart){chart.remove();chart=null;}
}

function goHome(){location.reload();}

loadHome();

</script>
</body>
</html>
